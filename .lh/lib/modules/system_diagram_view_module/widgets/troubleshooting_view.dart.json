{
    "sourceFile": "lib/modules/system_diagram_view_module/widgets/troubleshooting_view.dart",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1726318117097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1726318284988,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,9 @@\n import 'dart:convert';\r\n import 'package:flutter/material.dart';\r\n import 'package:provider/provider.dart';\r\n import 'package:shared_preferences/shared_preferences.dart';\r\n-import '../providers/diagram_experiment_planner_provider.dart';\r\n+import '../../../core/providers/experiment_planner_provider.dart';\r\n \r\n class TroubleshootingOverlay extends StatefulWidget {\r\n   @override\r\n   _TroubleshootingOverlayState createState() => _TroubleshootingOverlayState();\r\n"
                }
            ],
            "date": 1726318117097,
            "name": "Commit-0",
            "content": "// troubleshooting_overlay.dart\r\n\r\nimport 'dart:convert';\r\nimport 'package:flutter/material.dart';\r\nimport 'package:provider/provider.dart';\r\nimport 'package:shared_preferences/shared_preferences.dart';\r\nimport '../providers/diagram_experiment_planner_provider.dart';\r\n\r\nclass TroubleshootingOverlay extends StatefulWidget {\r\n  @override\r\n  _TroubleshootingOverlayState createState() => _TroubleshootingOverlayState();\r\n}\r\n\r\nclass _TroubleshootingOverlayState extends State<TroubleshootingOverlay> {\r\n  Map<String, Offset> _componentPositions = {};\r\n  Size _svgSize = Size.zero;\r\n\r\n  @override\r\n  void initState() {\r\n    super.initState();\r\n    _loadComponentPositions();\r\n    WidgetsBinding.instance.addPostFrameCallback((_) {\r\n      _updateSvgSize();\r\n    });\r\n  }\r\n\r\n  void _updateSvgSize() {\r\n    final RenderBox? renderBox = context.findRenderObject() as RenderBox?;\r\n    if (renderBox != null) {\r\n      setState(() {\r\n        _svgSize = renderBox.size;\r\n      });\r\n      // Initialize default positions now that size is known\r\n      _initializeDefaultPositions();\r\n    }\r\n  }\r\n\r\n  void _initializeDefaultPositions() {\r\n    setState(() {\r\n      _componentPositions = {\r\n        'Nitrogen Generator': Offset(_svgSize.width * 0.10, _svgSize.height * 0.80),\r\n        'MFC': Offset(_svgSize.width * 0.20, _svgSize.height * 0.70),\r\n        'Backline Heater': Offset(_svgSize.width * 0.30, _svgSize.height * 0.60),\r\n        'Frontline Heater': Offset(_svgSize.width * 0.40, _svgSize.height * 0.50),\r\n        'Precursor Heater 1': Offset(_svgSize.width * 0.50, _svgSize.height * 0.40),\r\n        'Precursor Heater 2': Offset(_svgSize.width * 0.60, _svgSize.height * 0.30),\r\n        'Reaction Chamber': Offset(_svgSize.width * 0.70, _svgSize.height * 0.20),\r\n        'Valve 1': Offset(_svgSize.width * 0.80, _svgSize.height * 0.10),\r\n        'Valve 2': Offset(_svgSize.width * 0.90, _svgSize.height * 0.10),\r\n        'Pressure Control System': Offset(_svgSize.width * 0.85, _svgSize.height * 0.85),\r\n        'Vacuum Pump': Offset(_svgSize.width * 0.75, _svgSize.height * 0.75),\r\n      };\r\n    });\r\n  }\r\n\r\n  Future<void> _loadComponentPositions() async {\r\n    final prefs = await SharedPreferences.getInstance();\r\n    final positionsJson = prefs.getString('component_positions_troubleshooting_overlay');\r\n    if (positionsJson != null) {\r\n      final positionsMap = jsonDecode(positionsJson) as Map<String, dynamic>;\r\n      setState(() {\r\n        _componentPositions = positionsMap.map((key, value) {\r\n          final offsetList = (value as List<dynamic>).cast<double>();\r\n          return MapEntry(key, Offset(offsetList[0], offsetList[1]));\r\n        });\r\n      });\r\n    } else {\r\n      // Initialize default positions if no saved positions are found\r\n      // _initializeDefaultPositions(); // Moved to _updateSvgSize\r\n    }\r\n  }\r\n\r\n  Future<void> _saveComponentPositions() async {\r\n    final prefs = await SharedPreferences.getInstance();\r\n    final positionsMap = _componentPositions.map((key, value) {\r\n      return MapEntry(key, [value.dx, value.dy]);\r\n    });\r\n    await prefs.setString('component_positions_troubleshooting_overlay', jsonEncode(positionsMap));\r\n  }\r\n\r\n  @override\r\n  Widget build(BuildContext context) {\r\n    return Consumer<SystemStateProvider>(\r\n      builder: (context, systemStateProvider, child) {\r\n        return Stack(\r\n          children: _componentPositions.entries.map((entry) {\r\n            final componentName = entry.key;\r\n            final componentPosition = entry.value;\r\n\r\n            // Get the component by name from the provider\r\n            final component = systemStateProvider.getComponentByName(componentName);
if (component == null) return SizedBox.shrink();\r\n\r\n            // Only display components that are activated\r\n            if (!component.isActivated) {\r\n              return SizedBox.shrink();\r\n            }\r\n\r\n            // Determine if the component has an error or warning status\r\n            if (component.status == ComponentStatus.normal) {\r\n              // No need to display normal components in troubleshooting overlay\r\n              return SizedBox.shrink();\r\n            }\r\n\r\n            return Positioned(\r\n              left: componentPosition.dx,\r\n              top: componentPosition.dy,\r\n              child: GestureDetector(\r\n                onPanUpdate: (details) {\r\n                  setState(() {\r\n                    _componentPositions[componentName] = Offset(\r\n                      componentPosition.dx + details.delta.dx,\r\n                      componentPosition.dy + details.delta.dy,\r\n                    );\r\n                  });\r\n                },\r\n                onPanEnd: (_) {\r\n                  _saveComponentPositions();\r\n                },\r\n                onTap: () => _showTroubleshootingDialog(context, component),\r\n                child: Container(\r\n                  width: 40, // Touch area size\r\n                  height: 40,\r\n                  alignment: Alignment.center,\r\n                  child: Icon(\r\n                    Icons.warning,\r\n                    color: _getStatusColor(component.status),\r\n                    size: 30,\r\n                  ),\r\n                ),\r\n              ),\r\n            );\r\n          }).toList(),\r\n        );\r\n      },\r\n    );\r\n  }\r\n\r\n  void _showTroubleshootingDialog(BuildContext context, SystemComponent component) {\r\n    showDialog(\r\n      context: context,\r\n      builder: (context) => AlertDialog(\r\n        title: Text('Troubleshoot ${component.name}'),\r\n        content: SingleChildScrollView(\r\n          child: Column(\r\n            children: [\r\n              Text('Status: ${component.status.toString().split('.').last}'),\r\n              SizedBox(height: 10),\r\n              if (component.errorMessages.isNotEmpty)\r\n                ...component.errorMessages.map((message) => Text('- $message')).toList()\r\n              else\r\n                Text('No error messages.'),\r\n            ],\r\n          ),\r\n        ),\r\n        actions: [\r\n          TextButton(\r\n            onPressed: () {\r\n              // Pass component.name instead of component object\r\n              final systemStateProvider = Provider.of<SystemStateProvider>(context, listen: false);\r\n              systemStateProvider.runDiagnostic(component.name);\r\n              Navigator.of(context).pop();\r\n            },\r\n            child: Text('Run Diagnostic'),\r\n          ),\r\n          TextButton(\r\n            onPressed: () => Navigator.of(context).pop(),\r\n            child: Text('Close'),\r\n          ),\r\n        ],\r\n      ),\r\n    );\r\n  }\r\n\r\n  Color _getStatusColor(ComponentStatus status) {\r\n    switch (status) {\r\n      case ComponentStatus.warning:\r\n        return Colors.yellow;\r\n      case ComponentStatus.error:\r\n        return Colors.red;\r\n      default:\r\n        return Colors.green; // Should not happen, but default to green\r\n    }\r\n  }\r\n}\r\n"
        }
    ]
}